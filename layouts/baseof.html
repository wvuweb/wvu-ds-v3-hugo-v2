<!DOCTYPE html>
<html lang="{{ or site.Language.LanguageCode site.Language.Lang }}" dir="{{ or site.Language.LanguageDirection `ltr` }}">
<head>
  {{- if eq hugo.Environment "production" }}
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-WPD5W8R');</script>
    <!-- End Google Tag Manager -->
  {{ end }}
  {{ partial "head.html" . }}
</head>
<body class="audience-{{ .Site.Params.audience }} bg-wvu-not-quite-white">
  {{- if eq hugo.Environment "production" }}
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WPD5W8R"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
  {{- end -}}

  <a class="visually-hidden-focusable" href="#wvu-main-content" data-pagefind-ignore>Skip to main content</a>

  {{ partial "components/wvu-emergency-alert" . }}
  {{ partial "alert-banner" . }}

  <header class="bg-wvu-blue" data-pagefind-ignore="all">
    {{ partial "header.html" . }}
  </header>

  {{ $secondaryNav := slice }}

  {{ with .Params.horizontal_subnav }}
    {{ partial "horizontal-subnav-v2" . }}
  {{ end }}

  {{ $topper := "" }}

  {{ if .Params.topper }}
    {{ $topper = .Params.topper }}
  {{ else if .Params.student_profile_topper }}
    {{ $topper = .Params.student_profile_topper }}
  {{ else if .Params.article_topper }}
    {{ $topper = .Params.article_topper }}
  {{ else if .Params.organization_topper }}
    {{ $topper = .Params.organization_topper }}
  {{ else if .Params.place_topper }}
    {{ $topper = .Params.place_topper }}
  {{ else if .Params.faculty_profile_topper }}
    {{ $topper = .Params.faculty_profile_topper }}
  {{ else if .Params.author_profile_topper }}
    {{ $topper = .Params.author_profile_topper }}
  {{ else if .Params.alumni_profile_topper }}
    {{ $topper = .Params.alumni_profile_topper }}
  {{ end }}
  
  {{ if and (not .IsHome) (not .Params._hide_breadcrumbs) }}
    {{ partial "breadcrumbs" (dict "rel_permalink" .RelPermalink "topper" $topper "schema" .Params._schema) }}
  {{ end }}

  {{ $topper := page.Params.topper }}

  {{ with page.Params.article_topper }}
    {{ $topper = . }}
  {{ end }}

  {{ if not .IsHome }}
    {{ if and (not $topper._bookshop_name) (ne .Kind "term") }}
      <section aria-labelledby="heading-label">
        <h1 id="heading-label" class="visually-hidden">{{ .Params.title }}</h1>
      </section>
    {{ end }}
  {{ end }}

  <main id="wvu-main-content" data-pagefind-body>
    {{ block "main" . }}{{ end }}
  </main>

  {{ partial "bookshop_partial" (slice "default-content" (dict "blocks" site.Data.default_content.default_content.default_content_blocks)) }}

  {{ partial "footer" . }}
  
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    /* global fetch */
    const wvuEmergencyAlert = (() => {
      'use strict';

      // Variables:
      const getEmergencyEl = document.querySelector('#js-emergency-alert');
      const getEmergencyEvents = getEmergencyEl.querySelector('#js-emergency-alert__events');
      const getEmergencyDomain = getEmergencyEl.querySelector('#js-emergency-alert-domain');
      const disableAlert = getEmergencyEl.dataset.disableEmergencyAlert || 'false';
      const emergencyAlertUrl = getEmergencyEl.dataset.emergencyAlertJsonFeed || 'https://emergency.wvu.edu/emergency.json';
      if (!emergencyAlertUrl) return;

      // Attempt to get boolean values from Custom Site Data:
      const isTrue = (value) => {
        if (typeof (value) === 'string') {
          value = value.trim().toLowerCase();
        }
        switch (value) {
          case true:
          case 'true':
          case 1:
          case '1':
          case 'on':
          case 'On':
          case 'yes':
          case 'Yes':
            return true;
          default:
            return false;
        }
      };

      // Fetch the data:
      const fetchData = async (apiUrl) => {
        try {
          const response = await fetch(apiUrl);
          if (!response.ok) {
            throw new Error(`âŒ WVU Emergency Alert Network response was not OK: ${response.status}`);
          }
          return await response.json();
        } catch (error) {
          console.error(`There was an error fetching the WVU Emergency Alert: ${error.message}`);
        }
      };

      // Get root domain from API endpoint URL:
      // Returns an array with two items:
      // [URL for display, URL for href]
      const getDomain = (url) => {
        const makeUrl = new URL(url);
        const parts = [];
        parts.push(makeUrl.host, makeUrl.origin); // 0: no https, 1: full root domain
        return parts;
      };

      // Changes URL of "For more information" link to match API endpoint root URL:
      const renderMoreInfoLink = (url = emergencyAlertUrl) => {
        const rootUrl = getDomain(url);
        getEmergencyDomain.innerText = rootUrl[0];
        getEmergencyDomain.href = rootUrl[1];
      };

      // Render the HTML:
      const renderAlert = (events) => {
        getEmergencyEvents.innerHTML = events.map((item) => {
          const { event } = item;
          const html = `
            <div class="event mt-3">
              <h3 class="h5 mb-1">
                ${event.title}
              </h3>
              <p class="small">
                <time datetime="${event.updated_at}">${event.updated_at_formatted}</time>
              </p>
              ${event.body}
            </div>
          `;
          return html;
        }).join('');
        renderMoreInfoLink();
        getEmergencyEl.classList.remove('d-none');
      };

      const init = async () => {
        if (isTrue(disableAlert)) return; // Don't show alert if it's disabled via Site Data.
        const apiResponse = await fetchData(emergencyAlertUrl);
        if (!apiResponse.emergency.status) return; // Stop here if there's not an emergency.
        renderAlert(apiResponse.emergency.events);
      };

      init();
    })();
  </script>

  {{- with resources.Get "js/parvus/parvus.min.js" }}
    <script src="{{ .RelPermalink }}"></script>
  {{- end }}

  {{- with resources.Get "js/parvus-gallery--custom.js" }}
    <script src="{{ .RelPermalink }}"></script>
  {{- end }}

</body>
</html>
